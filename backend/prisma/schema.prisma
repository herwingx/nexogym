generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -------------------------------------------------------------
// ENUMS
// -------------------------------------------------------------

enum SubscriptionTier {
  BASIC
  PRO_QR
  PREMIUM_BIO
}

enum Role {
  SUPERADMIN
  ADMIN
  RECEPTIONIST
  INSTRUCTOR
  COACH
  MEMBER
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  FROZEN
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum AccessMethod {
  MANUAL
  QR
  BIOMETRIC
}

enum AccessType {
  REGULAR
  COURTESY
}

enum TransactionType {
  RESTOCK
  LOSS
  SALE
}

enum BookingStatus {
  PENDING
  ATTENDED
  CANCELLED
}

// -------------------------------------------------------------
// MODELOS
// -------------------------------------------------------------

model Gym {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  status             String           @default("ACTIVE") // ACTIVE | SUSPENDED | CANCELLED
  deleted_at         DateTime?        // Soft delete; purga (hard delete) tras retención
  logo_url           String?          // White-label logo
  theme_colors       Json?            // Configuración de Theme/White-Labeling (ej. {"primary": "#ff0000"})
  subscription_tier  SubscriptionTier  @default(BASIC)
  modules_config     Json?            // Feature Flags por nivel de suscripción (trigger aplicado con db:push o db:trigger)
  n8n_config         Json?            // Configuración de mensajería por gym (sender/template/webhook overrides)
  rewards_config     Json?            // Portal de Gamificación: Reglas y recompensas
  api_key_hardware   String?          @unique // Sprint B9 hardware auth
  last_reactivated_at DateTime?       // Streak freeze: cuando pasó de SUSPENDED a ACTIVE (perdón 48h)

  // Relaciones inversas
  users                  User[]
  subscriptions          Subscription[]
  visits                 Visit[]
  products               Product[]
  inventory_transactions InventoryTransaction[]
  sales                  Sale[]
  sale_items             SaleItem[]
  cash_shifts            CashShift[]
  expenses               Expense[]
  audit_logs             AuditLog[]
  classes                GymClass[]
  bookings               ClassBooking[]
  routines               Routine[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model User {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auth_user_id        String?   @unique
  gym_id              String    @db.Uuid
  name                String?
  phone               String?
  profile_picture_url String?
  pin_hash            String? // Control de Acceso Manual / Biométrico
  role                Role      @default(MEMBER)
  current_streak      Int       @default(0) // Gamificación (solo se incrementa 1 vez por día calendario)
  last_visit_at       DateTime?  // Última visita (anti-passback 2h)
  last_checkin_date   DateTime?  @db.Date // Último día calendario con check-in (para racha)
  birth_date          DateTime?  @db.Date // Cumpleaños (n8n / retención)
  deleted_at          DateTime?  // Soft delete
  qr_token            String?   @unique // Token para QR; al regenerar se invalida el anterior

  // Relaciones
  gym                Gym            @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  subscriptions      Subscription[]
  visits             Visit[]
  cash_shifts        CashShift[]
  audit_logs         AuditLog[]
  instructor_classes GymClass[]     @relation("InstructorClasses")
  bookings           ClassBooking[]
  routines           Routine[]
  sales_made         Sale[]         @relation("SellerSales")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([gym_id, phone])
  @@index([gym_id])
}

model Subscription {
  id                 String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id             String             @db.Uuid
  user_id            String             @db.Uuid
  status             SubscriptionStatus @default(ACTIVE)
  expires_at         DateTime
  frozen_days_left   Int?
  allowed_start_time String? // Ej: "06:00" - Restricción horaria
  allowed_end_time   String? // Ej: "12:00"

  // Relaciones
  gym  Gym  @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([gym_id])
  @@index([user_id])
}

model Visit {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String       @db.Uuid
  user_id       String       @db.Uuid
  check_in_time DateTime     @default(now())
  access_method AccessMethod @default(MANUAL)
  access_type   AccessType   @default(REGULAR)

  // Relaciones
  gym  Gym  @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([gym_id])
  @@index([user_id])
  @@index([gym_id, check_in_time])
}

model GymClass {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id       String @db.Uuid
  instructor_id String @db.Uuid
  name         String
  description  String?
  capacity     Int
  day_of_week  Int // 0-6 (Domingo-Sábado)
  start_time   String // HH:mm
  end_time     String // HH:mm

  gym        Gym            @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  instructor User           @relation("InstructorClasses", fields: [instructor_id], references: [id])
  bookings   ClassBooking[]

  @@index([gym_id])
}

model ClassBooking {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id       String        @db.Uuid
  class_id     String        @db.Uuid
  user_id      String        @db.Uuid
  booking_date DateTime      @db.Date
  status       BookingStatus @default(PENDING)

  gym   Gym      @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  class GymClass @relation(fields: [class_id], references: [id], onDelete: Cascade)
  user  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([class_id])
  @@index([user_id])
}

model Routine {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id      String  @db.Uuid
  user_id     String  @db.Uuid
  name        String
  description String?

  gym       Gym                @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  exercises WorkoutExercise[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([gym_id])
  @@index([user_id])
}

model WorkoutExercise {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  routine_id String  @db.Uuid
  name       String
  sets       Int
  reps       Int
  weight     Decimal? @db.Decimal(10, 2)
  notes      String?

  routine Routine @relation(fields: [routine_id], references: [id], onDelete: Cascade)
}

model Product {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id     String    @db.Uuid
  barcode    String?
  name       String
  price      Decimal   @db.Decimal(10, 2)
  stock      Int       @default(0)
  deleted_at DateTime?

  // Relaciones
  gym                    Gym                    @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  sale_items             SaleItem[]
  inventory_transactions InventoryTransaction[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([gym_id, barcode])
  @@index([gym_id])
}

model InventoryTransaction {
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id     String          @db.Uuid
  product_id String          @db.Uuid
  type       TransactionType
  quantity   Int
  reason     String?

  // Relaciones
  gym     Gym     @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id])

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([product_id])
}

model Sale {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String   @db.Uuid
  cash_shift_id String?  @db.Uuid
  seller_id     String?  @db.Uuid // Staff que realizó la venta
  total         Decimal  @db.Decimal(10, 2)
  created_at    DateTime @default(now())

  // Relaciones
  gym        Gym        @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  cash_shift CashShift? @relation(fields: [cash_shift_id], references: [id])
  seller     User?      @relation("SellerSales", fields: [seller_id], references: [id])
  items      SaleItem[]

  @@index([gym_id])
  @@index([cash_shift_id])
}

model SaleItem {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id     String  @db.Uuid
  sale_id    String  @db.Uuid
  product_id String  @db.Uuid
  quantity   Int
  price      Decimal @db.Decimal(10, 2)

  // Relaciones
  gym     Gym     @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  sale    Sale    @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id])

  @@index([gym_id])
  @@index([sale_id])
}

model CashShift {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id           String      @db.Uuid
  user_id          String      @db.Uuid
  opened_at        DateTime    @default(now())
  closed_at        DateTime?
  opening_balance  Decimal     @db.Decimal(10, 2)
  expected_balance Decimal?    @db.Decimal(10, 2)
  actual_balance   Decimal?    @db.Decimal(10, 2)
  status           ShiftStatus @default(OPEN)

  // Relaciones
  gym      Gym       @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [user_id], references: [id])
  sales    Sale[]
  expenses Expense[]

  @@index([gym_id])
  @@index([user_id])
}

model Expense {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String  @db.Uuid
  cash_shift_id String  @db.Uuid
  amount        Decimal @db.Decimal(10, 2)
  description   String

  // Relaciones
  gym        Gym       @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  cash_shift CashShift @relation(fields: [cash_shift_id], references: [id])

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([cash_shift_id])
}

model AuditLog {
  id      String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id  String  @db.Uuid
  user_id String  @db.Uuid
  action  String
  details Json?

  // Relaciones
  gym  Gym  @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id])

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([user_id])
}
