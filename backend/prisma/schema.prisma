generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -------------------------------------------------------------
// ENUMS
// -------------------------------------------------------------

enum SubscriptionTier {
  BASIC
  PRO_QR
  PREMIUM_BIO
}

enum Role {
  SUPERADMIN
  ADMIN
  RECEPTIONIST
  INSTRUCTOR
  COACH
  MEMBER
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  FROZEN
  PENDING_PAYMENT   // Alta sin pago; requiere renovación (turno abierto) para activar
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum AccessMethod {
  MANUAL
  QR
  BIOMETRIC
}

enum AccessType {
  REGULAR
  COURTESY
}

enum TransactionType {
  RESTOCK
  LOSS
  SALE
}

enum BookingStatus {
  PENDING
  ATTENDED
  CANCELLED
}

enum ExpenseType {
  SUPPLIER_PAYMENT   // Pago a proveedores
  OPERATIONAL_EXPENSE // Gasto operativo del gym
  CASH_DROP          // Retiro de efectivo por el dueño
}

// -------------------------------------------------------------
// MODELOS
// -------------------------------------------------------------

model Gym {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  status             String           @default("ACTIVE") // ACTIVE | SUSPENDED | CANCELLED
  deleted_at         DateTime?        // Soft delete; purga (hard delete) tras retención
  logo_url           String?          // White-label logo
  theme_colors       Json?            // Configuración de Theme/White-Labeling (ej. {"primary": "#ff0000"})
  subscription_tier  SubscriptionTier  @default(BASIC)
  modules_config     Json?            // Feature Flags por nivel de suscripción (trigger aplicado con db:push o db:trigger)
  n8n_config         Json?            // Configuración de mensajería por gym (sender/template/webhook overrides)
  rewards_config     Json?            // Portal de Gamificación: Reglas y recompensas
  opening_config     Json?            // Días cerrados: { closed_weekdays: [0,6], closed_dates: ["01-01","12-25"] } no afectan racha
  api_key_hardware   String?          @unique // Sprint B9 hardware auth
  last_reactivated_at DateTime?       // Streak freeze: cuando pasó de SUSPENDED a ACTIVE (perdón 7 días para rachas)

  // Relaciones inversas
  users                  User[]
  subscriptions          Subscription[]
  visits                 Visit[]
  products               Product[]
  inventory_transactions InventoryTransaction[]
  sales                  Sale[]
  sale_items             SaleItem[]
  cash_shifts            CashShift[]
  expenses               Expense[]
  audit_logs             AuditLog[]
  classes                GymClass[]
  bookings               ClassBooking[]
  routines               Routine[]
  exercises              Exercise[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model User {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auth_user_id        String?   @unique
  gym_id              String    @db.Uuid
  name                String?
  phone               String?
  profile_picture_url String?
  pin_hash            String? // Control de Acceso Manual / Biométrico
  role                Role      @default(MEMBER)
  staff_permissions   Json?     // Overrides por usuario: { can_use_pos?, can_use_routines?, can_use_reception? }. Null = defaults por rol.
  current_streak       Int       @default(0) // Gamificación (solo se incrementa 1 vez por día calendario)
  last_visit_at        DateTime? // Última visita (anti-passback 2h)
  last_checkin_date    DateTime? @db.Date // Último día calendario con check-in (para racha)
  streak_freeze_until  DateTime? // Si set: al check-in, si diffDays>1 y now<=esta fecha, no se reinicia la racha (renovación 1–2 días tarde)
  birth_date           DateTime? @db.Date // Cumpleaños (n8n / retención)
  deleted_at           DateTime? // Soft delete
  qr_token             String?   @unique // Token para QR; al regenerar se invalida el anterior

  // Relaciones
  gym                Gym            @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  subscriptions      Subscription[]
  visits             Visit[]
  cash_shifts        CashShift[]
  audit_logs         AuditLog[]
  instructor_classes GymClass[]     @relation("InstructorClasses")
  bookings           ClassBooking[]
  routines           Routine[]
  sales_made         Sale[]         @relation("SellerSales")
  inventory_transactions InventoryTransaction[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([gym_id, phone])
  @@index([gym_id])
}

model Subscription {
  id                 String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id             String             @db.Uuid
  user_id            String             @db.Uuid
  status             SubscriptionStatus @default(ACTIVE)
  expires_at         DateTime
  frozen_days_left   Int?
  allowed_start_time String? // Ej: "06:00" - Restricción horaria
  allowed_end_time   String? // Ej: "12:00"
  plan_barcode       String? // Barcode del plan al renovar (ej. MEMBERSHIP, MEMBERSHIP_ANNUAL) para badge en lista

  // Relaciones
  gym  Gym  @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([gym_id])
  @@index([user_id])
}

model Visit {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String       @db.Uuid
  user_id       String       @db.Uuid
  check_in_time DateTime     @default(now())
  access_method AccessMethod @default(MANUAL)
  access_type   AccessType   @default(REGULAR)

  // Relaciones
  gym  Gym  @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([gym_id])
  @@index([user_id])
  @@index([gym_id, check_in_time])
}

model GymClass {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String   @db.Uuid
  instructor_id String   @db.Uuid
  name          String
  description   String?
  capacity      Int
  day_of_week   Int      // 0-6 (Domingo-Sábado)
  start_time    String   // HH:mm
  end_time      String   // HH:mm
  price         Decimal? @db.Decimal(10, 2) // Costo opcional para clases externas o especiales

  gym        Gym            @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  instructor User           @relation("InstructorClasses", fields: [instructor_id], references: [id])
  bookings   ClassBooking[]

  @@index([gym_id])
}

model ClassBooking {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id       String        @db.Uuid
  class_id     String        @db.Uuid
  user_id      String        @db.Uuid
  booking_date DateTime      @db.Date
  status       BookingStatus @default(PENDING)

  gym   Gym      @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  class GymClass @relation(fields: [class_id], references: [id], onDelete: Cascade)
  user  User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([class_id])
  @@index([user_id])
}

model Exercise {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id   String  @db.Uuid
  name     String
  category String? // e.g. "Pecho", "Piernas", "Espalda", "Hombros", "Brazos", "Core"

  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([gym_id, name])
  @@index([gym_id])
  @@index([gym_id, category])
}

model Routine {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id      String   @db.Uuid
  user_id     String?  @db.Uuid // null = plantilla base; set = asignada a socio
  name        String
  description String?

  gym       Gym                @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user      User?              @relation(fields: [user_id], references: [id], onDelete: SetNull)
  exercises WorkoutExercise[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([gym_id])
  @@index([user_id])
}

model WorkoutExercise {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  routine_id String  @db.Uuid
  name       String
  sets       Int
  reps       Int
  weight     Decimal? @db.Decimal(10, 2)
  notes      String?

  routine Routine @relation(fields: [routine_id], references: [id], onDelete: Cascade)
}

model Product {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id     String    @db.Uuid
  barcode    String?
  name       String
  price      Decimal   @db.Decimal(10, 2)
  stock      Int       @default(0)
  deleted_at DateTime?

  // Relaciones
  gym                    Gym                    @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  sale_items             SaleItem[]
  inventory_transactions InventoryTransaction[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([gym_id, barcode])
  @@index([gym_id])
}

model InventoryTransaction {
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id     String          @db.Uuid
  product_id String          @db.Uuid
  user_id    String?         @db.Uuid // Quién realizó el movimiento (restock, merma, venta)
  type       TransactionType
  quantity   Int
  reason     String?

  // Relaciones
  gym     Gym     @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id])
  user    User?   @relation(fields: [user_id], references: [id])

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([product_id])
  @@index([user_id])
}

model Sale {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String   @db.Uuid
  cash_shift_id String?  @db.Uuid
  seller_id     String?  @db.Uuid // Staff que realizó la venta
  total         Decimal  @db.Decimal(10, 2)
  receipt_folio String?  // V-YYYY-NNNNNN para auditoría y comprobante
  created_at    DateTime @default(now())

  // Relaciones
  gym        Gym        @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  cash_shift CashShift? @relation(fields: [cash_shift_id], references: [id])
  seller     User?      @relation("SellerSales", fields: [seller_id], references: [id])
  items      SaleItem[]

  @@index([gym_id])
  @@index([cash_shift_id])
}

// Secuencia de folios por gym y año (V-venta, R-renovación) para comprobantes y auditoría
model ReceiptSequence {
  gym_id       String   @db.Uuid
  year         Int
  sale_seq     Int      @default(0)
  renewal_seq  Int      @default(0)
  updated_at   DateTime @updatedAt

  @@id([gym_id, year])
}

model SaleItem {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id     String  @db.Uuid
  sale_id    String  @db.Uuid
  product_id String  @db.Uuid
  quantity   Int
  price      Decimal @db.Decimal(10, 2)

  // Relaciones
  gym     Gym     @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  sale    Sale    @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id])

  @@index([gym_id])
  @@index([sale_id])
}

model CashShift {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id           String      @db.Uuid
  user_id          String      @db.Uuid
  opened_at        DateTime    @default(now())
  closed_at        DateTime?
  opening_balance  Decimal     @db.Decimal(10, 2)
  expected_balance Decimal?    @db.Decimal(10, 2)
  actual_balance   Decimal?    @db.Decimal(10, 2)
  status           ShiftStatus @default(OPEN)

  // Relaciones
  gym      Gym       @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [user_id], references: [id])
  sales    Sale[]
  expenses Expense[]

  @@index([gym_id])
  @@index([user_id])
}

model Expense {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id        String      @db.Uuid
  cash_shift_id String      @db.Uuid
  type          ExpenseType @default(CASH_DROP)
  amount        Decimal     @db.Decimal(10, 2)
  description   String?     // Obligatorio en UI para SUPPLIER_PAYMENT y OPERATIONAL_EXPENSE

  // Relaciones
  gym        Gym       @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  cash_shift CashShift @relation(fields: [cash_shift_id], references: [id])

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([cash_shift_id])
}

model AuditLog {
  id      String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gym_id  String  @db.Uuid
  user_id String  @db.Uuid
  action  String
  details Json?

  // Relaciones
  gym  Gym  @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id])

  created_at DateTime @default(now())

  @@index([gym_id])
  @@index([user_id])
}
